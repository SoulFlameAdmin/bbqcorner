<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Corner BBQ ‚Äî –ü—Ä–æ—Å–ª–µ–¥–∏ –ø–æ—Ä—ä—á–∫–∞</title>
<meta name="theme-color" content="#0b0d10">
<link rel="icon" href="snimki/logo.png">

<style>
:root{
  --bg:#0b0d10; --panel:#12151a; --muted:#a7b0ba; --soft:#ffffff10;
  --accent:#ff7a00; --success:#22cc88; --warn:#ffd166; --danger:#ff6b6b;
  --radius:16px; --shadow:0 14px 40px rgba(0,0,0,.45);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
  background:radial-gradient(1200px 600px at 50% -20%, #17202a 0%, var(--bg) 55%);
  color:#fff; display:flex; align-items:flex-start; justify-content:center; padding:42px 14px 24px;
}
.wrap{width:min(860px, 100%);}

.header{ display:flex; align-items:center; gap:12px; margin-bottom:18px; }
.logo{width:36px;height:36px;border-radius:10px; background:#fff url("snimki/logo.png") center/80% no-repeat; border:1px solid #ffffffaa}
.brand{font-weight:900;letter-spacing:.3px}
.back{
  margin-left:auto;background:#1a1f26;border:1px solid var(--soft);color:#fff;border-radius:12px;
  padding:8px 12px;cursor:pointer;font-weight:800
}
.back:hover{filter:brightness(1.08)}

.card{
  background:linear-gradient(180deg,#151a20,#101317); border:1px solid var(--soft);
  border-radius:22px; box-shadow:var(--shadow); padding:20px;
}

.title{
  font-size:28px; font-weight:900; color:#fff; letter-spacing:.6px; margin:6px 2px 12px;
  display:flex; align-items:center; gap:10px
}
.title .dot{width:10px;height:10px;border-radius:999px;background:var(--accent);box-shadow:0 0 16px var(--accent)}

/* INPUT ROW + HITBOX FIX */
.input-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:8px; position:relative; }
.input-row input{
  flex:1; min-width:240px;
  background:#0e1217; color:#fff; border:1px solid var(--soft);
  border-radius:14px; padding:12px 14px; outline:none; font-weight:700; letter-spacing:1px;
}
.input-row input::placeholder{color:#7e8794}
.input-row button{
  background:var(--accent); border:none; color:#fff; font-weight:900;
  padding:12px 16px; border-radius:14px; cursor:pointer; box-shadow:0 10px 28px rgba(255,122,0,.25);
  position:relative; z-index:2; pointer-events:auto; /* <-- –≤–∏–Ω–∞–≥–∏ –∫–ª–∏–∫–∞–µ–º */
}

.help{color:var(--muted); font-size:13px; margin:2px 2px 14px}

.status-card{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px }
@media (max-width:640px){ .status-card{ grid-template-columns:1fr } }

.stat{ background:#0f141a; border:1px solid var(--soft); border-radius:14px; padding:14px 12px; }
.stat h4{margin:0 0 6px; font-size:14px; color:#b9c2cd; letter-spacing:.3px}
.value{ font-size:18px; font-weight:900; letter-spacing:.4px }
.value.ok{color:var(--success)} .value.warn{color:var(--warn)} .value.bad{color:var(--danger)} .value.accent{color:var(--accent)}

.banner{
  margin-top:16px; padding:12px 14px; border-radius:14px; border:1px dashed var(--soft);
  color:#cfd6df; background:#0d1217;
}

.footer-note{margin-top:20px; text-align:center; color:#7f8a97; font-size:12px}
hr.sep{border:none; height:1px; background:linear-gradient(90deg,transparent,#ffffff14,transparent); margin:14px 0}
.small{font-size:12px; color:#9aa6b2}

.kit{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:6px }
.kit .chip{ border:1px solid var(--soft); background:#0d1217; border-radius:10px; padding:6px 8px; font-size:12px; color:#c7d0da }
.copy{ margin-left:auto; background:transparent; color:#c7d0da; border:1px solid var(--soft); border-radius:10px; padding:6px 8px; cursor:pointer }
.copy:hover{filter:brightness(1.06)}
.hidden{display:none !important}
</style>
</head>
<body>
<div class="wrap">

  <div class="header">
    <div class="logo" aria-hidden="true"></div>
    <div class="brand">Corner BBQ</div>
    <button class="back" id="goHome">‚Üê –ù–∞—á–∞–ª–æ</button>
  </div>

  <div class="card">
    <div class="title"><span class="dot"></span> –ü—Ä–æ—Å–ª–µ–¥–∏ –ø–æ—Ä—ä—á–∫–∞</div>

    <div class="input-row">
      <input id="codeInput" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="–í—ä–≤–µ–¥–∏ 4-—Ü–∏—Ñ—Ä–µ–Ω –∫–æ–¥ –Ω–∞ –ø–æ—Ä—ä—á–∫–∞" autocomplete="one-time-code" />
      <button id="checkBtn" type="button">–ü—Ä–æ–≤–µ—Ä–∏</button>
    </div>
    <div class="help">–í—ä–≤–µ–¥–∏ –∫–æ–¥–∞, –∫–æ–π—Ç–æ –≤–∏–∂–¥–∞—à –Ω–∞–∫—Ä–∞—è –ø—Ä–∏ –ø–æ—Ä—ä—á–∫–∞. –ü–æ—Å–ª–µ–¥–Ω–æ –ø–æ–ª–∑–≤–∞–Ω: <span id="lastCode" class="small">‚Äî</span></div>

    <hr class="sep">

    <!-- –†–µ–∑—É–ª—Ç–∞—Ç -->
    <div id="resultEmpty" class="banner">üõà –í—ä–≤–µ–¥–∏ 4 —Ü–∏—Ñ—Ä–∏ –∏ –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äû–ü—Ä–æ–≤–µ—Ä–∏‚Äú, –∑–∞ –¥–∞ –≤–∏–¥–∏—à —Å—Ç–∞—Ç—É—Å–∞.</div>

    <div id="resultWrap" class="hidden">
      <div class="kit">
        <div class="chip">–ö–æ–¥: <b id="outCode">‚Äî</b></div>
        <div class="chip">–û–±—â–æ: <b id="outTotal">‚Äî</b></div>
        <div class="chip">–ö–ª–∏–µ–Ω—Ç: <b id="outName">‚Äî</b></div>
        <button class="copy" id="copyLink" type="button">–ö–æ–ø–∏—Ä–∞–π –ª–∏–Ω–∫ –∑–∞ –ø—Ä–æ—Å–ª–µ–¥—è–≤–∞–Ω–µ</button>
      </div>

      <div class="status-card">
        <div class="stat">
          <h4>–°—Ç–∞—Ç—É—Å</h4>
          <div id="outStatus" class="value">‚Äî</div>
        </div>
        <div class="stat">
          <h4>–í—Ä–µ–º–µ –∑–∞ –ø—Ä–∏–≥–æ—Ç–≤—è–Ω–µ (~–º–∏–Ω)</h4>
          <div id="outPrep" class="value">‚Äî</div>
        </div>
        <div class="stat">
          <h4>–í—Ä–µ–º–µ –∑–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ (~–º–∏–Ω)</h4>
          <div id="outDelivery" class="value">‚Äî</div>
        </div>
        <div class="stat">
          <h4>–ü—Ä–∏—á–∏–Ω–∞ (–∞–∫–æ –µ –æ—Ç–∫–∞–∑–∞–Ω–∞)</h4>
          <div id="outReason" class="value bad">‚Äî</div>
        </div>
      </div>

      <div class="banner small" id="liveInfo">–û–±–Ω–æ–≤—è–≤–∞ —Å–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –ø—Ä–æ–º—è–Ω–∞ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—Ç–∞.</div>
    </div>
  </div>

  <div class="footer-note">¬© Corner BBQ ‚Ä¢ live tracking</div>
</div>

<!-- Firebase (–º–æ–¥—É–ª–µ–Ω SDK) + –ª–æ–≥–∏–∫–∞ -->
<script type="module">
// ======= Firebase init (–º–æ–¥—É–ª–Ω–∞ –≤–µ—Ä—Å–∏—è v10) =======
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
import { getFirestore, doc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyAhaEPIEODEoRiwTulBw4W9YTXyMW9sqKg",
  authDomain: "corner-bbq.firebaseapp.com",
  projectId: "corner-bbq",
  storageBucket: "corner-bbq.firebasestorage.app",
  messagingSenderId: "878314744141",
  appId: "1:878314744141:web:f869886ee4380e9dbcaf04",
  measurementId: "G-FWBDL96GN0"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// ======= UI –µ–ª–µ–º–µ–Ω—Ç–∏ =======
const codeInput   = document.getElementById('codeInput');
const checkBtn    = document.getElementById('checkBtn');
const lastCodeEl  = document.getElementById('lastCode');
const resultEmpty = document.getElementById('resultEmpty');
const resultWrap  = document.getElementById('resultWrap');
const outCode     = document.getElementById('outCode');
const outTotal    = document.getElementById('outTotal');
const outName     = document.getElementById('outName');
const outStatus   = document.getElementById('outStatus');
const outPrep     = document.getElementById('outPrep');
const outDeliv    = document.getElementById('outDelivery');
const outReason   = document.getElementById('outReason');
const goHomeBtn   = document.getElementById('goHome');
const copyLinkBtn = document.getElementById('copyLink');

const LS_TRACK = 'bbq_track_code';

// ======= –ü–æ–º–æ—â–Ω–∏ =======
const fmtLv = v => typeof v==='number' ? (v.toFixed(2).replace('.',',') + ' –ª–≤.') : '‚Äî';
function showEmpty(message='üõà –í—ä–≤–µ–¥–∏ 4 —Ü–∏—Ñ—Ä–∏ –∏ –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äû–ü—Ä–æ–≤–µ—Ä–∏‚Äú, –∑–∞ –¥–∞ –≤–∏–¥–∏—à —Å—Ç–∞—Ç—É—Å–∞.') {
  resultWrap.classList.add('hidden');
  resultEmpty.textContent = message;
  resultEmpty.classList.remove('hidden');
}
function showResult() {
  resultEmpty.classList.add('hidden');
  resultWrap.classList.remove('hidden');
}
function markStatus(statusText){
  outStatus.className = 'value accent';
  const s = (statusText||'').toLowerCase();
  if (s.includes('–¥–æ—Å—Ç–∞–≤–µ–Ω–∞')) outStatus.className = 'value ok';
  else if (s.includes('–æ—Ç–∫–∞–∑')) outStatus.className = 'value bad';
  else if (s.includes('–≤ –¥–æ—Å—Ç–∞–≤–∫–∞') || s.includes('–ø–æ–¥–≥–æ—Ç–æ–≤') || s.includes('–ø—Ä–∏–µ—Ç–∞')) outStatus.className = 'value accent';
  else if (s.includes('—á–∞–∫–∞')) outStatus.className = 'value warn';
}

// ======= –ù–∞—á–∞–ª–æ –±—É—Ç–æ–Ω =======
goHomeBtn.addEventListener('click', e=>{
  e.preventDefault();
  const target = (location.protocol === 'file:') ? 'file:///E:/BBQ_SITE/index.html' : 'index.html';
  window.location.href = target;
});

// ======= Live —Å–ª—É—à–∞—Ç–µ–ª =======
let unsubscribe = null;

async function runCheck(){
  const code = (codeInput.value||'').trim();
  // –±—É—Ç–æ–Ω—ä—Ç –µ –≤–∏–Ω–∞–≥–∏ –∞–∫—Ç–∏–≤–µ–Ω; –ø—Ä–æ—Å—Ç–æ –≤–∞–ª–∏–¥–∏—Ä–∞–º–µ –≤—Ö–æ–¥–∞
  if (!/^\d{4}$/.test(code)) {
    showEmpty('‚ö† –í—ä–≤–µ–¥–∏ –≤–∞–ª–∏–¥–µ–Ω 4-—Ü–∏—Ñ—Ä–µ–Ω –∫–æ–¥.');
    return;
  }

  // —Å–ø—Ä–∏ —Å—Ç–∞—Ä —Å–ª—É—à–∞—Ç–µ–ª
  if (typeof unsubscribe === 'function') { unsubscribe(); unsubscribe = null; }

  try{
    const ref  = doc(db, 'orders', code);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      localStorage.setItem(LS_TRACK, code);
      showEmpty('‚ùå –ù–µ –æ—Ç–∫—Ä–∏–≤–∞–º–µ –ø–æ—Ä—ä—á–∫–∞ —Å —Ç–∞–∫—ä–≤ –∫–æ–¥. –ü—Ä–æ–≤–µ—Ä–∏ —Ü–∏—Ñ—Ä–∏—Ç–µ –∏–ª–∏ –æ–ø–∏—Ç–∞–π –ø–æ-–∫—ä—Å–Ω–æ.');
      return;
    }

    // –∑–∞–ø–∞–∑–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—è –∫–æ–¥ –∏ –≤–∫–ª—é—á–∏ live
    localStorage.setItem(LS_TRACK, code);
    lastCodeEl.textContent = code;

    unsubscribe = onSnapshot(ref, (docSnap)=>{
      if (!docSnap.exists()) { showEmpty('‚ùå –ü–æ—Ä—ä—á–∫–∞—Ç–∞ –≤–µ—á–µ –Ω–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞.'); return; }
      const d = docSnap.data() || {};
      const status = (d.status || d.state || '–ß–∞–∫–∞ –ø—Ä–∏–µ–º–∞–Ω–µ');

      outCode.textContent   = code;
      outTotal.textContent  = fmtLv(Number(d.total ?? d.totalPrice));
      outName.textContent   = (d.customer?.names || d.customerName || '‚Äî');

      outStatus.textContent = status;
      markStatus(status);

      outPrep.textContent   = (Number(d.prepEtaMin) > 0)     ? `${Number(d.prepEtaMin)} –º–∏–Ω`     : '‚Äî';
      outDeliv.textContent  = (Number(d.deliveryEtaMin) > 0) ? `${Number(d.deliveryEtaMin)} –º–∏–Ω` : '‚Äî';
      outReason.textContent = (status.toLowerCase().includes('–æ—Ç–∫–∞–∑') && d.canceledReason) ? d.canceledReason : '‚Äî';

      showResult();
    }, (err)=>{
      console.error(err);
      showEmpty('‚ö† –í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤—Ä—ä–∑–∫–∞—Ç–∞. –ü—Ä–µ–∑–∞—Ä–µ–¥–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞.');
    });

  }catch(err){
    console.error(err);
    showEmpty('‚ö† –í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞. –û–ø–∏—Ç–∞–π –æ—Ç–Ω–æ–≤–æ.');
  }
}

// ======= –ó–∞–∫–∞—á–∞–Ω–µ: –≤–∏–Ω–∞–≥–∏ —Ä–∞–±–æ—Ç–∏ —Å –∫–ª–∏–∫ –∏ Enter =======
checkBtn.addEventListener('click', runCheck);
codeInput.addEventListener('keydown', e=>{
  if(e.key === 'Enter'){ e.preventDefault(); runCheck(); }
});

// ======= –ê–≤—Ç–æ–∑–∞—Ä–µ–∂–¥–∞–Ω–µ –æ—Ç ?code= –∏–ª–∏ –æ—Ç LS =======
(function initFromURLAndLS(){
  const params = new URLSearchParams(location.search);
  const qCode  = params.get('code') || params.get('kod') || params.get('order');
  const saved  = localStorage.getItem(LS_TRACK) || '';
  lastCodeEl.textContent = saved || '‚Äî';

  if (qCode && /^\d{4}$/.test(qCode)) {
    showEmpty('‚è≥ –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ç—É—Å‚Ä¶');
    codeInput.value = qCode;
    runCheck();
  } else if (saved && /^\d{4}$/.test(saved)) {
    showEmpty('‚è≥ –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ç—É—Å‚Ä¶');
    codeInput.value = saved;
    runCheck();
  }
})();

// ======= –ö–æ–ø–∏—Ä–∞–Ω–µ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–µ–Ω –ª–∏–Ω–∫ =======
copyLinkBtn.addEventListener('click', async ()=>{
  try{
    const code = (codeInput.value||'').trim();
    if(!/^\d{4}$/.test(code)) return;
    const url = new URL(location.href);
    url.searchParams.set('code', code);
    await navigator.clipboard.writeText(url.toString());
    copyLinkBtn.textContent = '‚úÖ –ö–æ–ø–∏—Ä–∞–Ω–æ';
    setTimeout(()=> copyLinkBtn.textContent='–ö–æ–ø–∏—Ä–∞–π –ª–∏–Ω–∫ –∑–∞ –ø—Ä–æ—Å–ª–µ–¥—è–≤–∞–Ω–µ', 1200);
  }catch(_){}
});

// ======= –ü–æ—á–∏—Å—Ç–∏ listener –ø—Ä–∏ –Ω–∞–ø—É—Å–∫–∞–Ω–µ =======
addEventListener('beforeunload', ()=>{ if (typeof unsubscribe==='function') unsubscribe(); });
</script>
</body>
</html>
