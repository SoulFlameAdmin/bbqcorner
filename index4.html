<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Corner BBQ — Админ панел</title>
<style>
:root{
  --bg:#0e0f10; --soft:#ffffff1a; --accent:#ff7a00; --text:#fff;
  --ok:#86ff86; --warn:#ffcf7a; --bad:#ff8686;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
.wrap{max-width:1200px;margin:0 auto;padding:18px}

/* Header */
.header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap}
.title{font-weight:900;font-size:22px;color:var(--accent);letter-spacing:.4px}
.header-right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.stat{padding:6px 10px;border-radius:10px;background:#121316;border:1px solid var(--soft);font-weight:800}
.filter{display:flex;gap:6px;align-items:center}
.filter select,.filter input{
  background:#121316;border:1px solid var(--soft);color:#fff;border-radius:10px;padding:8px 10px;outline:none;min-height:38px
}
.filter input{min-width:240px}

/* Grid */
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
@media (max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:700px){.grid{grid-template-columns:1fr}}
.empty{padding:22px;text-align:center;border:1px dashed var(--soft);border-radius:12px;opacity:.8}

/* Card */
.card{
  background:#121316;border:1px solid var(--soft);border-radius:16px;padding:14px;box-shadow:0 8px 28px rgba(0,0,0,.28);
  position:relative;overflow:hidden
}
.row{display:flex;gap:8px;align-items:center;margin:6px 0;flex-wrap:wrap}
.badge{padding:4px 8px;border-radius:999px;background:#1a1c20;border:1px solid var(--soft);font-size:12px;font-weight:900}
.small{font-size:12px;opacity:.75}
.addr{margin-top:6px;font-size:14px;opacity:.95}
.items{margin-top:8px;border-top:1px dashed var(--soft);padding-top:8px;display:flex;flex-direction:column;gap:4px}
.item{display:flex;justify-content:space-between;font-size:14px}
.total{margin-top:10px;font-weight:900;display:flex;justify-content:flex-end}

/* Status */
.status{padding:4px 10px;border-radius:10px;font-size:12px;font-weight:900;background:#1a1c20;border:1px solid var(--soft)}
.status[data-s='ПРЕГЛЕД']{color:#f0f0f0}
.status[data-s='ПРИГОТВЯ СЕ']{background:#1e2a18;color:#95ff6b;border-color:#2c4a23}
.status[data-s='ДОСТАВЯ СЕ']{background:#262017;color:#ffcf7a;border-color:#554125}
.status[data-s='ДОСТАВЕНО']{background:#1c2a1c;color:#86ff86;border-color:#2a5a2a}
.status[data-s='ОТКАЗАНА']{background:#2a1c1c;color:#ff9a9a;border-color:#5a2a2a}

/* Buttons */
.btns{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.btn{
  background:#181a1f;border:1px solid var(--soft);color:#fff;border-radius:10px;padding:8px 10px;
  font-weight:800;cursor:pointer;transition:border-color .15s ease
}
.btn:hover{border-color:#ffffff33}
.btn.ok{background:#1f2a1f;border-color:#2a5a2a}
.btn.warn{background:#2a2418;border-color:#554125}
.btn.bad{background:#3a1515;border-color:#8a1f1f}

/* Inline inputs */
.inline{
  display:inline-flex;gap:6px;align-items:center;background:#181a1f;border:1px solid var(--soft);border-radius:10px;padding:6px 8px
}
.inline input{
  width:64px;background:transparent;border:none;color:#fff;outline:none;font-weight:800;text-align:center
}
.inline label{font-size:12px;opacity:.75}

/* Close (delete) */
.close{
  position:absolute;top:8px;right:8px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;
  border-radius:999px;background:#3a1515;border:1px solid #8a1f1f;color:#fff;font-weight:900;line-height:1;cursor:pointer
}
.close:hover{background:#4a1919;border-color:#b32626}

/* Note editor */
.noteWrap{margin-top:10px;border:1px solid var(--soft);border-radius:12px;overflow:hidden;background:#181a1f}
.noteHead{display:flex;justify-content:space-between;align-items:center;padding:8px 10px}
.noteHead strong{font-size:13px}
.noteBody{padding:8px 10px}
.noteBody textarea{
  width:100%;min-height:64px;background:#101215;border:1px solid #0000;color:#fff;border-radius:8px;padding:8px;outline:none;resize:vertical
}
.noteActions{display:flex;gap:8px;justify-content:flex-end;padding:8px 10px}

/* Top utility bar */
.topUtil{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.kbd{
  background:#1a1c20;border:1px solid var(--soft);border-bottom-color:#00000044;border-radius:8px;
  padding:4px 8px;font-size:12px;color:#cfd6d6
}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="title">Админ панел — Поръчки</div>
    <div class="header-right">
      <div class="filter">
        <select id="statusFilter" title="Филтър по статус">
          <option value="ALL">Всички (без ДОСТАВЕНО)</option>
          <option value="ПРЕГЛЕД">ПРЕГЛЕД</option>
          <option value="ПРИГОТВЯ СЕ">ПРИГОТВЯ СЕ</option>
          <option value="ДОСТАВЯ СЕ">ДОСТАВЯ СЕ</option>
          <option value="ДОСТАВЕНО">ДОСТАВЕНО</option>
          <option value="ОТКАЗАНА">ОТКАЗАНА</option>
        </select>
        <input id="searchBox" type="search" placeholder="Търси по име/телефон/адрес/код…">
      </div>
      <div class="stat"><span id="count">0</span> поръчки</div>
      <div class="stat">Оборот (Доставени): <span id="deliveredSum">0,00 лв.</span></div>
    </div>
  </div>

  <div class="topUtil">
    <span class="kbd">Клик върху „мин“ полета = запазва ETA</span>
    <span class="kbd">Статуси: Преглед → Приготвя се → Доставя се → Доставено</span>
    <span class="kbd">Бележка: редактирай и „Запази бележка“</span>
  </div>

  <div class="grid" id="grid"></div>
  <div id="emptyState" class="empty" style="display:none">Няма поръчки по текущия филтър.</div>
</div>

<audio id="newOrderSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script type="module">
/* ===== Gate (локален флаг) ===== */
const verified = localStorage.getItem('adminVerified') === '1';
if (!verified) {
  alert('❌ Нямаш достъп до админ панела. Моля, влез през началната страница.');
  window.location.href = 'index.html';
}

/* ===== Utils ===== */
const lv = n => (Number(n)||0).toFixed(2).replace('.',',')+' лв.';
const fmtWhen = ts => { try{ if (!ts) return ''; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString(); }catch(_){ return ''; } };
const esc = s => String(s||'').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));

/* ===== DOM ===== */
const grid = document.getElementById('grid');
const countE = document.getElementById('count');
const deliveredSumE = document.getElementById('deliveredSum');
const emptyE = document.getElementById('emptyState');
const selStatus = document.getElementById('statusFilter');
const searchBox = document.getElementById('searchBox');
const sound = document.getElementById('newOrderSound');

/* ===== Firebase ===== */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
import {
  getFirestore, collection, query, orderBy, onSnapshot,
  doc, updateDoc, deleteDoc, setDoc, serverTimestamp, deleteField
} from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
import {
  getAuth, signInAnonymously, onAuthStateChanged
} from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';

const firebaseConfig = {
  apiKey: "AIzaSyAhaEPIEODEoRiwTulBw4W9YTXyMW9sqKg",
  authDomain: "corner-bbq.firebaseapp.com",
  projectId: "corner-bbq",
  storageBucket: "corner-bbq.firebasestorage.app",
  messagingSenderId: "878314744141",
  appId: "1:878314744141:web:f869886ee4380e9dbcaf04",
  measurementId: "G-FWBDL96GN0"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);

/* === Sign-in (анонимен), за да минават rules === */
await signInAnonymously(auth).catch(()=>{});
await new Promise(res => onAuthStateChanged(auth, () => res(), { once: true }));

/* ===== Live ===== */
let orders = [];
let firstLoad = true;

const q = query(collection(db, 'orders'), orderBy('createdAt','desc'));
onSnapshot(q, (snap)=>{
  const newOrders = snap.docs.map(d => ({ id: d.id, code: d.id, ...d.data() }));
  if (!firstLoad && newOrders.length > orders.length) { sound.currentTime = 0; sound.play().catch(()=>{}); }
  firstLoad = false;
  orders = newOrders;
  render();
});

/* ===== Render + Filters ===== */
selStatus.addEventListener('change', render);
searchBox.addEventListener('input', render);

function render(){
  const fStatus = selStatus.value;
  const qTxt = (searchBox.value || '').trim().toLowerCase();

  const deliveredSum = orders
    .filter(o => (o.status||'') === 'ДОСТАВЕНО')
    .reduce((s,o)=> s + (Number(o.total)||0), 0);
  deliveredSumE.textContent = lv(deliveredSum);

  let filtered = orders.slice();
  filtered = filtered.filter(o=>{
    const s = (o.status||'');
    if (fStatus === 'ALL') return s !== 'ДОСТАВЕНО';
    return s === fStatus;
  });
  if (qTxt){
    filtered = filtered.filter(o=>{
      const c = o.customer || {};
      const hay = [o.id, c.names, c.phone, c.address, o.note].join(' ').toLowerCase();
      return hay.includes(qTxt);
    });
  }

  countE.textContent = String(filtered.length);
  emptyE.style.display = filtered.length ? 'none' : 'block';

  grid.innerHTML = filtered.map(o=>{
    const when   = fmtWhen(o.createdAt);
    const items  = Array.isArray(o.items) ? o.items : [];
    const status = o.status || 'ПРЕГЛЕД';
    const prep = Number(o.prepEtaMin)||0;
    const delv = Number(o.deliveryEtaMin)||0;
    const address = esc(o.customer?.address || '');
    const names   = esc(o.customer?.names || '');
    const phone   = esc(o.customer?.phone || '');
    const code    = o.id;
    const noteTxt = o.note || '';

    return `
      <div class="card" data-id="${code}">
        <button class="close" title="Изтрий" data-id="${code}">×</button>

        <div class="row">
          <span class="badge">Код: #${code}</span>
          <span class="small">${when}</span>
          <span class="status" data-s="${status}">${status}</span>
        </div>

        <div class="row"><strong>${names}</strong> <span class="small">(${phone})</span></div>
        <div class="addr">📍 ${address || '(без адрес)'}</div>

        <div class="items">
          ${items.map(it=>`
            <div class="item"><span>${esc(it.name||'')}</span><span>${lv(Number(it.price)||0)}</span></div>
          `).join('')}
        </div>

        <div class="total">Общо: ${lv(Number(o.total)||0)}</div>

        <div class="row" style="gap:10px;margin-top:10px;flex-wrap:wrap">
          <div class="inline">
            <label for="prep_${code}">Приготвяне</label>
            <input id="prep_${code}" type="number" min="0" step="1" value="${prep}" data-type="prep" data-id="${code}">
            <span class="small">мин</span>
          </div>
          <div class="inline">
            <label for="deliv_${code}">Доставка</label>
            <input id="deliv_${code}" type="number" min="0" step="1" value="${delv}" data-type="deliv" data-id="${code}">
            <span class="small">мин</span>
          </div>
        </div>

        <div class="noteWrap">
          <div class="noteHead"><strong>📝 Бележка към поръчката</strong></div>
          <div class="noteBody">
            <textarea id="note_${code}" placeholder="Въведи/редактирай бележка…">${esc(noteTxt)}</textarea>
          </div>
          <div class="noteActions">
            <button class="btn" data-action="save-note" data-id="${code}">Запази бележка</button>
          </div>
        </div>

        <div class="util">
          <button class="btn" data-action="copy" data-code="${code}">📋 Копирай кода</button>
          <button class="btn" data-action="link" data-code="${code}">🔗 Линк за клиента</button>
          <button class="btn" data-action="maps" data-address="${address}">🚗 Достави</button>
        </div>

        <div class="btns">
          ${status !== 'ДОСТАВЕНО' && status !== 'ОТКАЗАНА' ? `
            <button class="btn"     data-action="s" data-target="ПРЕГЛЕД"     data-id="${code}">ПРЕГЛЕД</button>
            <button class="btn ok"  data-action="s" data-target="ПРИГОТВЯ СЕ"  data-id="${code}">ПРИГОТВЯ СЕ</button>
            <button class="btn warn"data-action="s" data-target="ДОСТАВЯ СЕ"   data-id="${code}">ДОСТАВЯ СЕ</button>
            <button class="btn ok"  data-action="s" data-target="ДОСТАВЕНО"    data-id="${code}">ДОСТАВЕНО</button>
            <button class="btn bad" data-action="cancel" data-id="${code}">ОТКАЗАНА</button>
          ` : `
            <button class="btn"     data-action="s" data-target="ПРЕГЛЕД"     data-id="${code}">ПРЕГЛЕД</button>
            <button class="btn bad" data-action="cancel" data-id="${code}">ОТКАЗАНА</button>
          `}
        </div>
      </div>
    `;
  }).join('');

  bindUI();
}

/* ===== Bindings ===== */
function bindUI(){
  // статуси
  grid.querySelectorAll('[data-action="s"]').forEach(btn=>{
    btn.addEventListener('click', ()=> changeStatus(btn.dataset.id, btn.dataset.target));
  });

  // отказ
  grid.querySelectorAll('[data-action="cancel"]').forEach(btn=>{
    btn.addEventListener('click', ()=> cancelOrder(btn.dataset.id));
  });

  // изтриване
  grid.querySelectorAll('.close').forEach(b=>{
    b.addEventListener('click', ()=> deleteOrder(b.dataset.id));
  });

  // ETA inputs
  grid.querySelectorAll('.inline input').forEach(inp=>{
    const save = async ()=>{
      const id = inp.dataset.id;
      const type = inp.dataset.type;
      const val = Math.max(0, Number(inp.value)||0);
      const patch = (type === 'prep') ? { prepEtaMin: val } : { deliveryEtaMin: val };
      try {
        await updateDoc(doc(db, 'orders', id), patch);
        inp.style.borderColor = '#4cff84';
        setTimeout(()=> inp.style.borderColor='', 900);
      } catch(e) {
        // fallback
        try{
          await setDoc(doc(db,'orders',id), patch, { merge: true });
          inp.style.borderColor = '#4cff84';
          setTimeout(()=> inp.style.borderColor='', 900);
        }catch(err){
          console.error('ETA update error', err);
          alert('Неуспешно записване на ETA.');
        }
      }
    };
    inp.addEventListener('blur', save);
    inp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); inp.blur(); }});
  });

  // бележка – запис
  grid.querySelectorAll('[data-action="save-note"]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.dataset.id;
      const ta = document.getElementById('note_'+id);
      const note = (ta?.value || '').trim();
      try{
        await updateDoc(doc(db,'orders',id), { note });
        btn.textContent = '✔ Записано';
        setTimeout(()=> btn.textContent = 'Запази бележка', 1200);
      }catch(e){
        try{
          await setDoc(doc(db,'orders',id), { note }, { merge:true });
          btn.textContent = '✔ Записано';
          setTimeout(()=> btn.textContent = 'Запази бележка', 1200);
        }catch(err){
          console.error('note save error', err);
          alert('Неуспешно записване на бележката.');
        }
      }
    });
  });

  // утилити – копиране/линк/карта
  grid.querySelectorAll('[data-action="copy"]').forEach(b=>{
    b.addEventListener('click', async ()=>{
      const code = b.dataset.code;
      try{ await navigator.clipboard.writeText(code); b.textContent='✔ Копирано'; setTimeout(()=>b.textContent='📋 Копирай кода',1200);}
      catch(_){ alert('Копирайте ръчно: '+code); }
    });
  });

  grid.querySelectorAll('[data-action="link"]').forEach(b=>{
    b.addEventListener('click', async ()=>{
      const code = b.dataset.code;
      const base = (location.protocol==='file:') ? 'index6.html' : new URL('index6.html', location.href).toString();
      const url = (base.includes('?')?base:base) + (base.includes('?')?'&':'?') + 'code=' + encodeURIComponent(code);
      try{ await navigator.clipboard.writeText(url); b.textContent='✔ Линк копиран'; setTimeout(()=>b.textContent='🔗 Линк за клиента',1200);}
      catch(_){ prompt('Копирай линка:', url); }
    });
  });

  grid.querySelectorAll('[data-action="maps"]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const address = b.dataset.address || '';
      if(!address.trim()) return alert('Адресът липсва.');
      const url = `https://www.google.com/maps/dir/?api=1&travelmode=driving&destination=${encodeURIComponent(address)}`;
      window.open(url,'_blank');
    });
  });
}

/* ===== Ops ===== */
async function changeStatus(id, targetStatus){
  try{
    const patch = { status: targetStatus };
    if (targetStatus === 'ПРИГОТВЯ СЕ')  patch.prepEtaMin     = deleteField();
    if (targetStatus === 'ДОСТАВЯ СЕ')   patch.deliveryEtaMin = deleteField();
    if (targetStatus === 'ДОСТАВЕНО')    patch.deliveryEtaMin = 0;

    await updateDoc(doc(db,'orders',id), patch);
  }catch(err){
    // fallback
    try{
      await setDoc(doc(db,'orders',id), { status: targetStatus }, { merge:true });
    }catch(e){
      console.error(e);
      alert('Неуспешна промяна на статус.');
    }
  }
}

async function cancelOrder(id){
  try{
    const reason = prompt('Причина за отказ:');
    if (!reason) return;
    await updateDoc(doc(db,'orders',id), { status:'ОТКАЗАНА', canceledReason: reason });
  }catch(err){
    try{
      await setDoc(doc(db,'orders',id), { status:'ОТКАЗАНА', canceledReason: reason }, { merge:true });
    }catch(e){
      console.error(e);
      alert('Неуспешен отказ.');
    }
  }
}

async function deleteOrder(id){
  try{
    const ok = confirm('Сигурен ли си, че искаш да изтриеш тази поръчка?');
    if (!ok) return;
    await deleteDoc(doc(db,'orders',id));
  }catch(err){ console.error(err); alert('Грешка при изтриване.'); }
}

/* ===== Optional local click log ===== */
(function(){
  const who = (localStorage.getItem('adminName') || '').trim();
  if(!who) return;
  function logAction(text){
    const k = `logs_${who}`;
    const now = new Date();
    const entry = `${now.toLocaleString()} — ${who} ${text}`;
    const arr = JSON.parse(localStorage.getItem(k) || '[]');
    arr.unshift(entry);
    localStorage.setItem(k, JSON.stringify(arr));
    const known = new Set(JSON.parse(localStorage.getItem('logs__admins')||'[]'));
    known.add(who);
    localStorage.setItem('logs__admins', JSON.stringify([...known]));
  }
  document.addEventListener('click', e=>{
    let desc = '';
    if(e.target.closest('button, a, input, select, textarea')){
      const el = e.target.closest('button, a, input, select, textarea');
      const tag = el.tagName.toLowerCase();
      const label = el.innerText || el.value || el.id || '(без текст)';
      desc = `кликна върху ${tag} → "${label.trim().slice(0,60)}"`;
    } else desc = `кликна на произволно място (${e.clientX}x${e.clientY})`;
    const page = location.pathname.split('/').pop() || 'непозната страница';
    logAction(`${desc} [${page}]`);
  });
  logAction(`влезе в системата (${location.pathname.split('/').pop()})`);
})();
</script>
</body>
</html>
