<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Corner BBQ ‚Äî –ê–¥–º–∏–Ω</title>
<style>
:root{ --bg:#0e0f10; --soft:#ffffff1a; --accent:#ff7a00; --text:#fff; }
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.wrap{max-width:1200px;margin:0 auto;padding:18px}
.header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap}
.title{font-weight:900;font-size:20px;color:var(--accent)}
.header-right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.small{font-size:12px;opacity:.75}
.stat{padding:6px 10px;border-radius:10px;background:#121316;border:1px solid var(--soft);font-weight:800}
.filter{display:flex;gap:6px;align-items:center}
.filter select, .filter input{
  background:#121316;border:1px solid var(--soft);color:#fff;border-radius:10px;padding:6px 10px;outline:none
}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
@media (max-width:1024px){.grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:640px){.grid{grid-template-columns:1fr}}

.card{
  background:#121316;border:1px solid var(--soft);border-radius:16px;padding:14px;box-shadow:0 8px 28px rgba(0,0,0,.28);
  position:relative;overflow:hidden
}
.row{display:flex;gap:8px;align-items:center;margin:6px 0;flex-wrap:wrap}
.badge{padding:4px 8px;border-radius:999px;background:#1a1c20;border:1px solid var(--soft);font-size:12px;font-weight:800}
.status{padding:4px 10px;border-radius:10px;font-size:12px;font-weight:900;background:#1a1c20;border:1px solid var(--soft)}
.status[data-s='–ü–†–ï–ì–õ–ï–î']{color:#f0f0f0}
.status[data-s='–ü–†–ò–ì–û–¢–í–Ø –°–ï']{background:#1e2a18;color:#95ff6b;border-color:#2c4a23}
.status[data-s='–î–û–°–¢–ê–í–Ø –°–ï']{background:#262017;color:#ffcf7a;border-color:#554125}
.status[data-s='–î–û–°–¢–ê–í–ï–ù–û']{background:#1c2a1c;color:#86ff86;border-color:#2a5a2a}
.items{margin-top:8px;border-top:1px dashed var(--soft);padding-top:8px}
.item{display:flex;justify-content:space-between;margin:4px 0;font-size:14px}
.total{margin-top:10px;font-weight:900;display:flex;justify-content:flex-end}
.addr{margin-top:6px;font-size:14px;opacity:.95}
.btns{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.btn{background:#181a1f;border:1px solid var(--soft);color:#fff;border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer}
.btn:hover{border-color:#ffffff33}
.empty{padding:20px;text-align:center;border:1px dashed var(--soft);border-radius:12px}

/* X –±—É—Ç–æ–Ω */
.close{
  position:absolute;top:8px;right:8px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;
  border-radius:999px;background:#3a1515;border:1px solid #8a1f1f;color:#fff;font-weight:900;line-height:1;cursor:pointer
}
.close:hover{background:#4a1919;border-color:#b32626}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="title">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª ‚Äî –ü–æ—Ä—ä—á–∫–∏</div>
    <div class="header-right">
      <div class="filter">
        <select id="statusFilter" title="–§–∏–ª—Ç—ä—Ä –ø–æ —Å—Ç–∞—Ç—É—Å">
          <option value="ALL">–í—Å–∏—á–∫–∏</option>
          <option value="–ü–†–ï–ì–õ–ï–î">–ü–†–ï–ì–õ–ï–î</option>
          <option value="–ü–†–ò–ì–û–¢–í–Ø –°–ï">–ü–†–ò–ì–û–¢–í–Ø –°–ï</option>
          <option value="–î–û–°–¢–ê–í–Ø –°–ï">–î–û–°–¢–ê–í–Ø –°–ï</option>
          <option value="–î–û–°–¢–ê–í–ï–ù–û">–î–û–°–¢–ê–í–ï–ù–û</option>
        </select>
        <input id="searchBox" type="search" placeholder="–¢—ä—Ä—Å–∏ –ø–æ –∏–º–µ/—Ç–µ–ª–µ—Ñ–æ–Ω/–∞–¥—Ä–µ—Å‚Ä¶">
      </div>
      <div class="stat"><span id="count">0</span> –ø–æ—Ä—ä—á–∫–∏</div>
      <div class="stat">–û–±–æ—Ä–æ—Ç (–î–æ—Å—Ç–∞–≤–µ–Ω–∏): <span id="deliveredSum">0,00 –ª–≤.</span></div>
    </div>
  </div>

  <div class="grid" id="grid"></div>
  <div id="emptyState" class="empty" style="display:none">–ù—è–º–∞ –ø–æ—Ä—ä—á–∫–∏.</div>
</div>

<script type="module">
/* ===== –ü–æ–º–æ—â–Ω–∏ ===== */
const lv = n => (Number(n)||0).toFixed(2).replace('.',',')+' –ª–≤.';
const fmtWhen = ts => {
  try{ if (!ts) return ''; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString(); }
  catch(_){ return ''; }
};
const grid = document.getElementById('grid');
const countE = document.getElementById('count');
const deliveredSumE = document.getElementById('deliveredSum');
const emptyE = document.getElementById('emptyState');
const selStatus = document.getElementById('statusFilter');
const searchBox = document.getElementById('searchBox');

/* ===== Firebase ===== */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
import {
  getFirestore, collection, query, orderBy, onSnapshot,
  doc, updateDoc, deleteDoc
} from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyAhaEPIEODEoRiwTulBw4W9YTXyMW9sqKg",
  authDomain: "corner-bbq.firebaseapp.com",
  projectId: "corner-bbq",
  storageBucket: "corner-bbq.firebasestorage.app",
  messagingSenderId: "878314744141",
  appId: "1:878314744141:web:f869886ee4380e9dbcaf04",
  measurementId: "G-FWBDL96GN0"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ===== –†–µ–∞–ª–Ω–æ –≤—Ä–µ–º–µ ===== */
let orders = [];
const q = query(collection(db, 'orders'), orderBy('createdAt','desc'));

onSnapshot(q, (snap)=>{
  orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render();
});

/* ===== –†–µ–Ω–¥–µ—Ä ===== */
selStatus.addEventListener('change', render);
searchBox.addEventListener('input', render);

function render(){
  const fStatus = selStatus.value;
  const queryTxt = (searchBox.value || '').trim().toLowerCase();

  // –æ–±–æ—Ä–æ—Ç (–î–æ—Å—Ç–∞–≤–µ–Ω–∏)
  const deliveredSum = orders
    .filter(o => (o.status||'') === '–î–û–°–¢–ê–í–ï–ù–û')
    .reduce((s,o)=> s + (Number(o.total)||0), 0);
  deliveredSumE.textContent = lv(deliveredSum);

  // –ª–æ–≥–∏–∫–∞ –Ω–∞ —Ñ–∏–ª—Ç—Ä–∏—Ç–µ:
  // "ALL" => –≤—Å–∏—á–∫–æ –ë–ï–ó –¥–æ—Å—Ç–∞–≤–µ–Ω–∏—Ç–µ
  // "–î–û–°–¢–ê–í–ï–ù–û" => —Å–∞–º–æ –¥–æ—Å—Ç–∞–≤–µ–Ω–∏
  let filtered = orders.filter(o=>{
    const s = (o.status||'');
    if (fStatus === 'ALL') return s !== '–î–û–°–¢–ê–í–ï–ù–û';
    if (fStatus === '–î–û–°–¢–ê–í–ï–ù–û') return s === '–î–û–°–¢–ê–í–ï–ù–û';
    return s === fStatus;
  });

  // —Ç—ä—Ä—Å–µ–Ω–µ
  if (queryTxt){
    filtered = filtered.filter(o=>{
      const c = o.customer || {};
      return [c.names, c.phone, c.address].join(' ').toLowerCase().includes(queryTxt);
    });
  }

  countE.textContent = String(filtered.length);
  emptyE.style.display = filtered.length ? 'none' : 'block';

  grid.innerHTML = filtered.map(o=>{
    const when = fmtWhen(o.createdAt);
    const items = Array.isArray(o.items) ? o.items : [];
    const status = o.status || '–ü–†–ï–ì–õ–ï–î';

    // –ù—è–º–∞ –±—É—Ç–æ–Ω–∏ –∑–∞ —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –î–û–°–¢–ê–í–ï–ù–û (–Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ)
    const statusBtns = status === '–î–û–°–¢–ê–í–ï–ù–û' ? '' : `
      <button class="btn btn-prev" data-id="${o.id}">–ü–†–ï–ì–õ–ï–î</button>
      <button class="btn btn-cook" data-id="${o.id}">–ü–†–ò–ì–û–¢–í–Ø –°–ï</button>
      <button class="btn btn-deliver" data-id="${o.id}">–î–û–°–¢–ê–í–Ø –°–ï</button>
      <button class="btn btn-done" data-id="${o.id}">–î–û–°–¢–ê–í–ï–ù–û</button>`;

    return `
    <div class="card" data-id="${o.id}">
      <button class="close" title="–ò–∑—Ç—Ä–∏–π" data-id="${o.id}">√ó</button>
      <div class="row">
        <span class="badge">#${o.id.slice(0,6)}</span>
        <span class="small muted">${when}</span>
        <span class="status" data-s="${status}">${status}</span>
      </div>
      <div class="row"><strong>${o.customer?.names||''}</strong> <span class="small">(${o.customer?.phone||''})</span></div>
      <div class="addr">üìç ${o.customer?.address||''}</div>
      <div class="items">
        ${items.map(it=>`<div class="item"><span>${escapeHTML(it.name||'')}</span><span>${lv(Number(it.price)||0)}</span></div>`).join('')}
      </div>
      <div class="total">–û–±—â–æ: ${lv(Number(o.total)||0)}</div>
      <div class="btns">${statusBtns}</div>
    </div>`;
  }).join('');

  bindButtons();
}

function escapeHTML(s){
  return String(s||'').replace(/[&<>"']/g, ch => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[ch]));
}

/* ===== –î–µ–π—Å—Ç–≤–∏—è ===== */
function bindButtons(){
  grid.querySelectorAll('.btn-prev').forEach(b=>b.addEventListener('click', ()=> changeStatus(idOf(b),'–ü–†–ï–ì–õ–ï–î')));
  grid.querySelectorAll('.btn-cook').forEach(b=>b.addEventListener('click', ()=> changeStatus(idOf(b),'–ü–†–ò–ì–û–¢–í–Ø –°–ï')));
  grid.querySelectorAll('.btn-deliver').forEach(b=>b.addEventListener('click', ()=> changeStatus(idOf(b),'–î–û–°–¢–ê–í–Ø –°–ï')));
  grid.querySelectorAll('.btn-done').forEach(b=>b.addEventListener('click', ()=> changeStatus(idOf(b),'–î–û–°–¢–ê–í–ï–ù–û')));
  grid.querySelectorAll('.close').forEach(b=>b.addEventListener('click', ()=> deleteOrder(idOf(b))));
}
const idOf = (btn) => btn.dataset.id;

async function changeStatus(id, targetStatus){
  try{
    const o = orders.find(x=>x.id===id);
    if (!o) return;

    // ‚ùó –ù–ï–û–ë–†–ê–¢–ò–ú–û: –∞–∫–æ –µ –î–û–°–¢–ê–í–ï–ù–û ‚Äî –±–ª–æ–∫–∏—Ä–∞–π –≤—Å—è–∫–∞–∫–≤–∞ –ø—Ä–æ–º—è–Ω–∞
    if ((o.status||'') === '–î–û–°–¢–ê–í–ï–ù–û'){
      alert('–¢–∞–∑–∏ –ø–æ—Ä—ä—á–∫–∞ –≤–µ—á–µ –µ –î–û–°–¢–ê–í–ï–ù–û –∏ –Ω–µ –º–æ–∂–µ –¥–∞ —Å–µ –ø—Ä–æ–º–µ–Ω—è.');
      return;
    }

    await updateDoc(doc(db,'orders',id), { status: targetStatus });

    // –ª–æ–∫–∞–ª–Ω–æ –æ–±–Ω–æ–≤–∏
    o.status = targetStatus;

    // –∞–∫–æ —Ç–æ–∫—É-—â–æ —Å—Ç–∞–Ω–∞ –î–û–°–¢–ê–í–ï–ù–û –∏ –Ω–µ —Å–º–µ –≤—ä–≤ —Ñ–∏–ª—Ç—ä—Ä ‚Äû–î–û–°–¢–ê–í–ï–ù–û‚Äú ‚Üí –º–∞—Ö–Ω–∏ –∫–∞—Ä—Ç–∞—Ç–∞ –≤–µ–¥–Ω–∞–≥–∞
    if (targetStatus === '–î–û–°–¢–ê–í–ï–ù–û' && selStatus.value !== '–î–û–°–¢–ê–í–ï–ù–û'){
      const card = grid.querySelector(`.card[data-id="${id}"]`);
      if (card) card.remove();
    }

    render(); // —â–µ —Å–∫—Ä–∏–µ/–ø–æ–∫–∞–∂–µ —Å–ø–æ—Ä–µ–¥ —Ñ–∏–ª—Ç—ä—Ä–∞
  }catch(err){
    console.error(err);
    alert('–ù–µ—É—Å–ø–µ—à–Ω–∞ –ø—Ä–æ–º—è–Ω–∞.');
  }
}

async function deleteOrder(id){
  try{
    const o = orders.find(x => x.id === id);
    if (!o) return;

    if ((o.status||'') === '–î–û–°–¢–ê–í–ï–ù–û'){
      const pwd = prompt('–ü–∞—Ä–æ–ª–∞ –∑–∞ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ –î–û–°–¢–ê–í–ï–ù–ê –ø–æ—Ä—ä—á–∫–∞:');
      if (pwd !== 'mitakathebest!'){ alert('‚ùå –ì—Ä–µ—à–Ω–∞ –ø–∞—Ä–æ–ª–∞.'); return; }
    } else if (!confirm('–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏, —á–µ –∏—Å–∫–∞—à –¥–∞ –∏–∑—Ç—Ä–∏–µ—à —Ç–∞–∑–∏ –ø–æ—Ä—ä—á–∫–∞?')) return;

    await deleteDoc(doc(db,'orders',id));
    const card = grid.querySelector(`.card[data-id="${id}"]`);
    if(card) card.remove();
  }catch(err){
    console.error(err);
    alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ.');
  }
}
</script>
</body>
</html>
