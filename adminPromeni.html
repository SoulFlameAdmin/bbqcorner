<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BBQ Admin</title>
<style>
  body{font-family:system-ui, sans-serif;max-width:1000px;margin:24px auto;padding:0 12px}
  .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  fieldset{border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0}
  label{display:block;margin:6px 0 2px;font-weight:600}
  input,select,button,textarea{padding:8px;border:1px solid #ccc;border-radius:6px}
  .list{padding:8px;border:1px dashed #bbb;border-radius:8px}
  .item{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eee}
  .item:last-child{border-bottom:none}
  small{opacity:.75}
</style>
</head>
<body>

<h1>BBQ Admin</h1>
<div id="authRow" class="row">
  <button id="loginBtn">Вход с Google</button>
  <div id="me"></div>
</div>

<fieldset>
  <legend>Ред на категории</legend>
  <div class="row">
    <input id="orderInput" style="flex:1" placeholder="cat1,cat2,cat3">
    <button id="saveOrder">Запази реда</button>
  </div>
  <small>Списък от catId, разделени със запетая.</small>
</fieldset>

<fieldset>
  <legend>Категория</legend>
  <div class="row">
    <input id="catId" placeholder="catId (напр. burgeri)">
    <button id="loadCat">Зареди</button>
    <button id="createCat">Нова</button>
    <button id="deleteCat">Изтрий</button>
  </div>
  <div id="catForm" style="display:none">
    <label>Заглавие</label>
    <input id="catTitle">
    <label>Изглед</label>
    <select id="catView">
      <option value="">(стандартен)</option>
      <option value="gallery">Галерия (Hell)</option>
      <option value="water2">Двойки (вода)</option>
    </select>
    <label>Hell Price</label>
    <input id="catHellPrice" type="number" step="0.01" placeholder="само за HELL">
    <label>Thumb URL</label>
    <input id="catThumb">
    <div class="row">
      <input id="thumbFile" type="file" accept="image/*">
      <button id="uploadThumb">Качи thumb</button>
      <button id="saveCat">Запази категория</button>
    </div>
  </div>
</fieldset>

<fieldset id="itemsBox" style="display:none">
  <legend>Артикули</legend>
  <div class="list" id="itemsList"></div>
  <h4>Нов/Редакция</h4>
  <label>id (остави празно за нов)</label>
  <input id="itemId">
  <label>Име</label>
  <input id="itemName">
  <label>Цена</label>
  <input id="itemPrice" type="number" step="0.01">
  <label>Описание</label>
  <textarea id="itemDesc"></textarea>
  <label>Картинка URL</label>
  <input id="itemImg">
  <div class="row">
    <input id="itemFile" type="file" accept="image/*">
    <button id="uploadItemImg">Качи картинка</button>
    <button id="saveItem">Запази артикул</button>
    <button id="deleteItem">Изтрий артикул</button>
  </div>
  <small>За категории с групи работи аналогично, но през секцията „Групи“ (по желание я добавяме после).</small>
</fieldset>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js';

const firebaseConfig = { /* същият config */ };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// --- auth
const loginBtn = document.getElementById('loginBtn');
const me = document.getElementById('me');
loginBtn.onclick = async ()=>{
  const prov = new GoogleAuthProvider();
  await signInWithPopup(auth, prov);
};
onAuthStateChanged(auth, user=>{
  me.textContent = user ? `Вписан: ${user.email}` : 'Не си вписан';
});

// --- settings/order
const orderInput = document.getElementById('orderInput');
document.getElementById('saveOrder').onclick = async ()=>{
  const list = orderInput.value.split(',').map(s=>s.trim()).filter(Boolean);
  await setDoc(doc(db,'settings','catalog'), { order:list }, { merge:true });
  alert('Редът е запазен.');
};
(async ()=>{
  const s = await getDoc(doc(db,'settings','catalog'));
  if (s.exists()) orderInput.value = (s.data().order || []).join(',');
})();

// --- category CRUD
const catIdEl = document.getElementById('catId');
const catForm = document.getElementById('catForm');
const catTitle = document.getElementById('catTitle');
const catView  = document.getElementById('catView');
const catHell  = document.getElementById('catHellPrice');
const catThumb = document.getElementById('catThumb');

document.getElementById('loadCat').onclick = async ()=>{
  const id = catIdEl.value.trim();
  if (!id) return;
  const snap = await getDoc(doc(db,'categories',id));
  if (snap.exists()){
    const d = snap.data();
    catForm.style.display = '';
    catTitle.value = d.title || '';
    catView.value  = d.view || '';
    catHell.value  = (d.hellPrice ?? '');
    catThumb.value = d.thumb || '';
    await loadItems(); // зареди items
  } else {
    alert('Няма такава категория.');
    catForm.style.display = 'none';
    document.getElementById('itemsBox').style.display='none';
  }
};
document.getElementById('createCat').onclick = async ()=>{
  const id = catIdEl.value.trim();
  if (!id) return;
  await setDoc(doc(db,'categories',id), { title:id.toUpperCase() });
  alert('Категорията е създадена. Зареди я.');
};
document.getElementById('deleteCat').onclick = async ()=>{
  const id = catIdEl.value.trim();
  if (!id) return;
  await deleteDoc(doc(db,'categories',id));
  alert('Категорията е изтрита.');
};

document.getElementById('saveCat').onclick = async ()=>{
  const id = catIdEl.value.trim();
  if (!id) return;
  const payload = {
    title: catTitle.value.trim(),
    view:  catView.value || null,
    hellPrice: catView.value==='gallery' ? Number(catHell.value||0) : null,
    thumb: catThumb.value || null
  };
  await setDoc(doc(db,'categories',id), payload, { merge:true });
  alert('Категорията е запазена.');
};

// --- upload thumb
document.getElementById('uploadThumb').onclick = async ()=>{
  const id = catIdEl.value.trim();
  if (!id) return alert('Въведи catId');
  const file = document.getElementById('thumbFile').files[0];
  if (!file) return;
  const r = ref(storage, `thumbs/${id}/${file.name}`);
  await uploadBytes(r, file);
  const url = await getDownloadURL(r);
  catThumb.value = url;
  alert('Качено.');
};

// --- items CRUD (за стандартни категории)
const itemsBox  = document.getElementById('itemsBox');
const itemsList = document.getElementById('itemsList');
const itemId    = document.getElementById('itemId');
const itemName  = document.getElementById('itemName');
const itemPrice = document.getElementById('itemPrice');
const itemDesc  = document.getElementById('itemDesc');
const itemImg   = document.getElementById('itemImg');

async function loadItems(){
  const id = catIdEl.value.trim();
  const snap = await getDocs(collection(db,'categories',id,'items'));
  itemsBox.style.display='';
  itemsList.innerHTML = '';
  snap.forEach(d=>{
    const it = d.data();
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div>
        <b>${it.name}</b> — ${Number(it.price||0).toFixed(2)} лв
        <div><small>${d.id}</small></div>
      </div>
      <div>
        <button data-edit="${d.id}">Редакция</button>
        <button data-del="${d.id}">X</button>
      </div>`;
    itemsList.appendChild(div);
  });
  itemsList.onclick = async (e)=>{
    const ed = e.target.closest('[data-edit]');
    const dl = e.target.closest('[data-del]');
    const id = catIdEl.value.trim();
    if (ed){
      const iid = ed.dataset.edit;
      const s = await getDoc(doc(db,'categories',id,'items',iid));
      if (s.exists()){
        const it = s.data();
        itemId.value = iid;
        itemName.value = it.name || '';
        itemPrice.value = it.price ?? '';
        itemDesc.value = it.desc || '';
        itemImg.value  = it.img || '';
      }
    }
    if (dl){
      const iid = dl.dataset.del;
      if (confirm('Изтриване?')){
        await deleteDoc(doc(db,'categories',id,'items',iid));
        await loadItems();
      }
    }
  };
}

document.getElementById('saveItem').onclick = async ()=>{
  const cid = catIdEl.value.trim();
  if (!cid) return;
  const iid = (itemId.value || '').trim() || crypto.randomUUID();
  const payload = {
    name: itemName.value.trim(),
    price: Number(itemPrice.value || 0),
    desc: itemDesc.value.trim() || null,
    img:  itemImg.value.trim() || null
  };
  await setDoc(doc(db,'categories',cid,'items',iid), payload, { merge:true });
  await loadItems();
  alert('Артикулът е запазен.');
};

document.getElementById('deleteItem').onclick = async ()=>{
  const cid = catIdEl.value.trim();
  const iid = itemId.value.trim();
  if (!cid || !iid) return;
  await deleteDoc(doc(db,'categories',cid,'items',iid));
  await loadItems();
  alert('Изтрито.');
};

// upload item image
document.getElementById('uploadItemImg').onclick = async ()=>{
  const file = document.getElementById('itemFile').files[0];
  const cid = catIdEl.value.trim();
  if (!file || !cid) return;
  const r = ref(storage, `items/${cid}/${file.name}`);
  await uploadBytes(r, file);
  const url = await getDownloadURL(r);
  itemImg.value = url;
  alert('Качено.');
};
</script>
</body>
</html>
